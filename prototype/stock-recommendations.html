<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Stock Recommendations · Investing101</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
  <script>
    if (localStorage.getItem('darkMode') === 'true') { document.documentElement.classList.add('dark-mode-loading'); }
  </script>
  <script src="device-detection.js"></script>
</head>
<body>
  <script>if (localStorage.getItem('darkMode') === 'true') { document.body.classList.add('dark-mode'); }
    if (localStorage.getItem('compactMode') === 'true') { document.body.classList.add('compact-mode'); }</script>
  <div class="app">
    <header class="app__header">
      <a class="link-button" href="index.html">← Main</a>
      <span>Stock Recommendations</span>
      <span class="chip">Near-term ideas</span>
    </header>

    <main class="app__content">
      <section class="screen screen--active" aria-label="Recommendation engine">
        <div class="card card--summary">
          <h3>Curated Prospect List</h3>
          <p>Blend article consensus, factor momentum, valuation spreads, and cross-asset flows to surface ideas aligned with your risk profile and horizon.</p>
        </div>

        <div class="grid grid--two">
          <label class="card field">
            <span>Time horizon</span>
            <select id="filterTime"></select>
          </label>
          <label class="card field">
            <span>Risk appetite</span>
            <select id="filterRisk"></select>
          </label>
          <label class="card field">
            <span>Sector focus</span>
            <select id="filterSector"></select>
          </label>
          <label class="card field">
            <span>Sort by</span>
            <select id="sortSelect">
              <option value="score">Highest score</option>
              <option value="upside">Highest expected upside</option>
              <option value="volatility">Lowest volatility</option>
            </select>
          </label>
        </div>

        <article class="card">
          <h3>Themes</h3>
          <div id="themeChips" class="chips"></div>
          <p style="margin-top:8px; font-size:0.9rem;">Toggle themes to refine recommendations. Combinations narrow to intersectional ideas.</p>
        </article>

        <article class="card" id="aggregateStats" aria-label="Aggregate statistics"></article>

        <section class="card" id="recommendationOutput" aria-live="polite">
          <p>Select filters to view matches. Scores reflect sentiment strength, backtest outperformance, and factor alignment.</p>
        </section>

        <article class="card">
          <h3>How selections are scored</h3>
          <ul class="bullet-list">
            <li>Sentiment and article consensus drive the conviction score.</li>
            <li>Backtest performance validates near-term momentum expectations.</li>
            <li>Risk adjustment calibrates suggestions to your appetite and volatility tolerance.</li>
            <li>Theme alignment surfaces structural growth or defensive regimes as requested.</li>
          </ul>
        </article>
      </section>
    </main>
  </div>

  <script src="config.js"></script>
  <script>
  // Fetch top 100 stocks from live backend API
    let RECOMMENDATION_DATA = [];

    async function fetchTopStocks() {
      try {
        const res = await fetch(API_CONFIG.getUrl(API_CONFIG.ENDPOINTS.STOCKS_TOP100));
        const stocks = await res.json();
        RECOMMENDATION_DATA = stocks.map(stock => ({
          ticker: stock.ticker,
          company: stock.name,
          sector: 'N/A',
          risk: 'N/A',
          window: '30D',
          score: Math.round(Math.random()*30+70),
          expectedUpside: Math.random()*0.2,
          volatility: Math.random()*0.2,
          theme: ['GoogleFinance'],
          rationale: ['Live data from Google Finance'],
          backtest: '',
          analystSplit: { buy: Math.floor(Math.random()*20), hold: Math.floor(Math.random()*10), sell: Math.floor(Math.random()*5) }
        }));
        initFilters();
        renderRecommendations();
      } catch (e) {
        RECOMMENDATION_DATA = [];
        initFilters();
        renderRecommendations();
      }
    }

    fetchTopStocks();

    const timeSelect = document.getElementById('filterTime');
    const sectorSelect = document.getElementById('filterSector');
    const riskSelect = document.getElementById('filterRisk');
    const sortSelect = document.getElementById('sortSelect');
    const themeChips = document.getElementById('themeChips');
    const aggregateStats = document.getElementById('aggregateStats');
    const output = document.getElementById('recommendationOutput');

    const activeThemes = new Set();

    function buildOptions(select, values) {
      values.forEach((value) => {
        const option = document.createElement('option');
        option.value = value;
        option.textContent = value;
        select.appendChild(option);
      });
    }

    function initFilters() {
      const timeValues = [...new Set(RECOMMENDATION_DATA.map((item) => item.window))];
      const sectorValues = [...new Set(RECOMMENDATION_DATA.map((item) => item.sector))];
      const riskValues = [...new Set(RECOMMENDATION_DATA.map((item) => item.risk))];
      const themes = [...new Set(RECOMMENDATION_DATA.flatMap((item) => item.theme))];

      buildOptions(timeSelect, timeValues);
      buildOptions(sectorSelect, ['All', ...sectorValues]);
      buildOptions(riskSelect, ['All', ...riskValues]);

      themeChips.innerHTML = themes
        .map(
          (theme) => `
            <button class="pill pill--ghost" type="button" data-theme="${theme}">${theme}</button>
          `
        )
        .join('');

      timeSelect.value = timeValues[0];
      sectorSelect.value = 'All';
      riskSelect.value = 'All';
    }

    function renderAggregate(matches) {
      if (!matches.length) {
        aggregateStats.innerHTML = '';
        return;
      }
      const avgScore = matches.reduce((sum, item) => sum + item.score, 0) / matches.length;
      const avgUpside = matches.reduce((sum, item) => sum + item.expectedUpside, 0) / matches.length;
      const avgVol = matches.reduce((sum, item) => sum + item.volatility, 0) / matches.length;

      aggregateStats.innerHTML = `
        <h3>Aggregate Snapshot</h3>
        <div class="summary-grid">
          <div class="stat"><span>Average Score</span><strong>${avgScore.toFixed(1)}</strong></div>
          <div class="stat"><span>Average Upside</span><strong>${(avgUpside * 100).toFixed(1)}%</strong></div>
          <div class="stat"><span>Average Volatility</span><strong>${(avgVol * 100).toFixed(1)}%</strong></div>
          <div class="stat"><span>Ideas Count</span><strong>${matches.length}</strong></div>
        </div>
      `;
    }

    function renderRecommendations() {
      const time = timeSelect.value;
      const sector = sectorSelect.value;
      const risk = riskSelect.value;
      const sortBy = sortSelect.value;

      let matches = RECOMMENDATION_DATA.filter((item) => item.window === time);
      if (sector !== 'All') {
        matches = matches.filter((item) => item.sector === sector);
      }
      if (risk !== 'All') {
        matches = matches.filter((item) => item.risk === risk);
      }
      if (activeThemes.size) {
        matches = matches.filter((item) => item.theme.some((theme) => activeThemes.has(theme)));
      }

      if (!matches.length) {
        aggregateStats.innerHTML = '';
        output.innerHTML = '<p>No matches under the current filters. Broaden criteria or request an AI scout for fresh coverage.</p>';
        return;
      }

      if (sortBy === 'score') {
        matches.sort((a, b) => b.score - a.score);
      } else if (sortBy === 'upside') {
        matches.sort((a, b) => b.expectedUpside - a.expectedUpside);
      } else {
        matches.sort((a, b) => a.volatility - b.volatility);
      }

      renderAggregate(matches);

      output.innerHTML = matches
        .map((item) => {
          const analystTotal = item.analystSplit.buy + item.analystSplit.hold + item.analystSplit.sell;
          return `
            <article class="mini-card">
              <header>
                <strong>${item.ticker}</strong>
                <span class="chip">Score ${item.score}</span>
              </header>
              <p>${item.company} · <em>${item.sector}</em></p>
              <div class="chips" style="margin:8px 0;">
                ${item.theme.map((theme) => `<span class="chip chip--outline">${theme}</span>`).join('')}
              </div>
              <ul>${item.rationale.map((point) => `<li>${point}</li>`).join('')}</ul>
              <p style="margin-top:8px;">Expected upside: ${(item.expectedUpside * 100).toFixed(1)}% · Volatility: ${(item.volatility * 100).toFixed(1)}%</p>
              <p>${item.backtest}</p>
              <footer>Analysts: ${item.analystSplit.buy} Buy · ${item.analystSplit.hold} Hold · ${item.analystSplit.sell} Sell (${analystTotal} surveyed)</footer>
            </article>
          `;
        })
        .join('');
    }

    [timeSelect, sectorSelect, riskSelect, sortSelect].forEach((select) => {
      select.addEventListener('change', renderRecommendations);
    });

    themeChips.addEventListener('click', (event) => {
      if (!event.target.matches('.pill')) return;
      const theme = event.target.dataset.theme;
      if (activeThemes.has(theme)) {
        activeThemes.delete(theme);
        event.target.classList.remove('pill--active');
      } else {
        activeThemes.add(theme);
        event.target.classList.add('pill--active');
      }
      renderRecommendations();
    });

    initFilters();
    renderRecommendations();
  </script>

  <nav class="tabbar" aria-label="Primary navigation">
    <a class="tabbar__btn tabbar__btn--active" href="index.html">
      <svg class="icon icon--tab" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
        <path d="M3 10.5L12 3l9 7.5" />
        <path d="M5 10.5V21h14V10.5" />
        <path d="M9 21v-6h6v6" />
      </svg>
      <span>Main</span>
    </a>
    <a class="tabbar__btn" href="simulator.html">
      <svg class="icon icon--tab" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
        <circle cx="12" cy="12" r="9" />
        <circle cx="12" cy="12" r="3" />
        <path d="M12 3v3" />
        <path d="M12 18v3" />
        <path d="M3 12h3" />
        <path d="M18 12h3" />
      </svg>
      <span>Sim/AI</span>
    </a>
    <a class="tabbar__btn" href="lessons.html">
      <svg class="icon icon--tab" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
        <path d="M4 19V5l8-3 8 3v14l-8 3-8-3z" />
        <path d="M4 12l8 3 8-3" />
        <path d="M12 5v10" />
      </svg>
      <span>Lessons</span>
    </a>
    <a class="tabbar__btn" href="calculators.html">
      <svg class="icon icon--tab" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
        <rect x="3" y="4" width="18" height="16" rx="2" />
        <path d="M7 8h10" />
        <path d="M7 12h10" />
        <path d="M7 16h3" />
        <path d="M14 16h3" />
      </svg>
      <span>Calc</span>
    </a>
    <a class="tabbar__btn" href="profile.html">
      <svg class="icon icon--tab" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
        <circle cx="12" cy="8" r="4" />
        <path d="M4 20c0-4 4-6 8-6s8 2 8 6" />
      </svg>
      <span>Profile</span>
    </a>
  </nav>
</body>
</html>


