<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Play the AI · Investing101</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
  <script>
    if (localStorage.getItem('darkMode') === 'true') { document.documentElement.classList.add('dark-mode-loading'); }
  </script>
</head>
<body>
  <script>if (localStorage.getItem('darkMode') === 'true') { document.body.classList.add('dark-mode'); }
    if (localStorage.getItem('compactMode') === 'true') { document.body.classList.add('compact-mode'); }</script>
  <div class="app">
    <header class="app__header">
      <a class="link-button" href="index.html">← Sim/AI</a>
      <span>Play the AI</span>
      <span class="chip">Historical data</span>
    </header>

    <main class="app__content">
      <section class="screen screen--active" aria-label="AI opponent customizer">
        <div class="card card--summary">
          <h3>Configure Your Match</h3>
          <p>Choose an opponent archetype and set the duration and difficulty. The engine will select historical market slices server-side to drive each session.</p>
        </div>

        <form class="card" id="aiForm">
          <label class="field">
            <span>Opponent style</span>
            <select id="opponentSelect">
              <option value="safe">Safe · defensive capital preservation</option>
              <option value="intermediate">Intermediate · balanced exposures</option>
              <option value="risky">Risky · aggressive growth seeking</option>
              <option value="random">Random · roulette of tactics</option>
            </select>
          </label>
          <label class="field">
            <span>Match duration</span>
            <!-- Duration slider: 1 day -> 3650 days (~10 years) -->
            <div style="display:flex;align-items:center;gap:12px;">
              <input type="range" id="durationRange" min="1" max="3650" value="1" step="1" style="flex:1;">
              <output id="durationLabel">1 day</output>
            </div>
            <small style="display:block;color:var(--text-muted);margin-top:6px;">Use the slider to pick any duration between 1 day and 10 years.</small>
          </label>
          <label class="field">
            <span>Opponent difficulty</span>
            <div style="display:flex;align-items:center;gap:12px;">
              <input type="range" id="difficultyRange" min="0" max="100" value="75" step="5" style="flex:1;">
              <output id="difficultyLabel">75%</output>
            </div>
            <small style="display:block;color:var(--text-muted);margin-top:6px;">Difficulty controls the opponent's trade accuracy and precision (higher = better AI performance).</small>
          </label>
          <button class="btn btn--primary" type="submit" id="submitBtn">Generate Game Plan</button>
        </form>

        <article class="card" id="aiSummary" aria-live="polite">
          <p>Pick your settings to see the AI’s loadout, recommended bankroll targets, and achievement hooks.</p>
        </article>

        <article class="card">
          <h3>Achievements to chase</h3>
          <ul class="bullet-list">
            <li>Shutout: Beat the AI by 5% or more.</li>
            <li>Clutch comeback: Finish positive after a 10% drawdown.</li>
            <li>Risk whisperer: Match the AI’s Sharpe ratio within ±0.1.</li>
          </ul>
        </article>
      </section>
    </main>
  </div>

  <script>

  const OPPONENTS = {
      safe: {
        name: 'Safe Guardian',
        focus: 'Capital preservation',
        tactics: ['High cash buffer', 'Bond hedges', 'Stops at 3%'],
        weakness: 'Misses fast rallies'
      },
      intermediate: {
        name: 'Balanced Navigator',
        focus: 'Risk-adjusted growth',
        tactics: ['Smart beta ETFs', 'Factor tilts', 'Weekly rebalancing'],
        weakness: 'Slow to react to shocks'
      },
      risky: {
        name: 'Aggro Hawk',
        focus: 'Max upside',
        tactics: ['High leverage', 'Sector concentration', 'Momentum chases'],
        weakness: 'Large drawdowns'
      },
      random: {
        name: 'Chaos Dealer',
        focus: 'Unpredictable',
        tactics: ['Randomized orders', 'Surprise hedges', 'Mixed leverage'],
        weakness: 'Inconsistent risk profile'
      }
    };

    // No scenario selector on the client: server will pick historical slices.

    function humanizeDuration(days) {
      if (days <= 1) return '1 day';
      if (days < 7) return `${days} days`;
      if (days < 30) return `${Math.round(days/7)} week(s)`;
      if (days < 365) return `${Math.round(days/30)} month(s)`;
      return `${(days/365).toFixed(1)} year(s)`;
    }

    function renderSummary(opponentId, durationDays, difficultyPct, stats) {
      const opponent = OPPONENTS[opponentId];
      const summary = document.getElementById('aiSummary');
      if (!opponent) {
        summary.innerHTML = '<p>Choose valid options to preview the matchup.</p>';
        return;
      }
      const durationText = humanizeDuration(durationDays);
      const diffLabel = difficultyPct >= 80 ? 'Hard' : difficultyPct >= 50 ? 'Medium' : 'Easy';

      // If server stats are provided, render them prominently
      let serverStatsHtml = '';
      if (stats) {
        serverStatsHtml = `
          <h4>Simulation results</h4>
          <ul class="bullet-list">
            <li>Return: <strong>${(stats.returnPct*100).toFixed(2)}%</strong></li>
            <li>Annualized volatility (est): <strong>${(stats.volatilityPct*100).toFixed(2)}%</strong></li>
            <li>Trading days: <strong>${stats.tradingDays}</strong></li>
            <li>Wins / Losses: <strong>${stats.wins} / ${stats.losses}</strong></li>
          </ul>
        `;
      }

      summary.innerHTML = `
        <header class="analysis__header">
          <strong>${opponent.name}</strong>
          <span class="chip">Focus: ${opponent.focus}</span>
        </header>
        <p>Duration: <strong>${durationText}</strong> &middot; Difficulty: <strong>${diffLabel}</strong></p>
        <ul class="bullet-list">
          ${opponent.tactics.map((tactic) => `<li>${tactic}</li>`).join('')}
        </ul>
        <p><em>Exploit:</em> ${opponent.weakness}</p>
        ${serverStatsHtml}
      `;
    }

    // Wire form and controls
    const aiForm = document.getElementById('aiForm');
    const durationRange = document.getElementById('durationRange');
    const durationLabel = document.getElementById('durationLabel');
    const difficultyRange = document.getElementById('difficultyRange');
    const difficultyLabel = document.getElementById('difficultyLabel');

    function syncDurationLabel() {
      const days = parseInt(durationRange.value, 10);
      durationLabel.value = humanizeDuration(days);
    }

    function syncDifficultyLabel() {
      difficultyLabel.value = `${difficultyRange.value}%`;
    }

    // Persist settings
    function saveSettings() {
      localStorage.setItem('ai_opponent', document.getElementById('opponentSelect').value);
      localStorage.setItem('ai_duration_days', durationRange.value);
      localStorage.setItem('ai_difficulty_pct', difficultyRange.value);
    }

    // Restore if present
    function restoreSettings() {
      const opp = localStorage.getItem('ai_opponent');
      const dur = localStorage.getItem('ai_duration_days');
      const diff = localStorage.getItem('ai_difficulty_pct');
      if (opp) document.getElementById('opponentSelect').value = opp;
      if (dur) durationRange.value = dur;
      if (diff) difficultyRange.value = diff;
      syncDurationLabel();
      syncDifficultyLabel();
    }

    durationRange.addEventListener('input', syncDurationLabel);
    difficultyRange.addEventListener('input', syncDifficultyLabel);

    aiForm.addEventListener('submit', async (event) => {
      event.preventDefault();
      const opponent = document.getElementById('opponentSelect').value;
      const durationDays = parseInt(durationRange.value, 10);
      const difficultyPct = parseInt(difficultyRange.value, 10);
      saveSettings();

      const submitBtn = document.getElementById('submitBtn');
      const originalText = submitBtn.textContent;
      submitBtn.disabled = true;
      submitBtn.textContent = 'Generating...';

      // POST to backend simulate endpoint. The server will choose historical slices.
      try {
        const payload = JSON.stringify({ opponent, durationDays, difficultyPct });
        const res = (window.apiClient && window.apiClient.fetchWithAuth)
          ? await window.apiClient.fetchWithAuth('/api/simulate', { method: 'POST', body: payload })
          : await fetch('/api/simulate', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: payload });
        if (!res.ok) throw new Error('Server error: ' + res.status);
        const data = await res.json();
        if (data && data.stats) {
          renderSummary(opponent, durationDays, difficultyPct, data.stats);
        } else {
          // Fallback to client preview if response unexpected
          renderSummary(opponent, durationDays, difficultyPct);
        }
      } catch (err) {
        console.warn('Simulation request failed, showing client preview:', err);
        const summary = document.getElementById('aiSummary');
        summary.innerHTML = `
          <div style="color: var(--error-color); padding: 16px; border: 1px solid var(--error-color); border-radius: 8px; background: var(--error-bg);">
            <h4>❌ Simulation Failed</h4>
            <p>Unable to generate game plan. Please check your connection and try again.</p>
            <p><small>Error: ${err.message}</small></p>
          </div>
        `;
        renderSummary(opponent, durationDays, difficultyPct);
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = originalText;
      }
    });

    // No scenarios to populate on the client; server will pick historical data.
    restoreSettings();
    // initial render using restored/default values
    renderSummary(
      document.getElementById('opponentSelect').value,
      parseInt(document.getElementById('durationRange').value, 10),
      parseInt(document.getElementById('difficultyRange').value, 10)
    );
  </script>

  <script src="api-client.js"></script>
  <script src="auth-widget.js"></script>

  <nav class="tabbar" aria-label="Primary navigation">
    <a class="tabbar__btn" href="index.html">
      <svg class="icon icon--tab" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
        <path d="M3 10.5L12 3l9 7.5" />
        <path d="M5 10.5V21h14V10.5" />
        <path d="M9 21v-6h6v6" />
      </svg>
      <span>Main</span>
    </a>
    <a class="tabbar__btn tabbar__btn--active" href="simulator.html">
      <svg class="icon icon--tab" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
        <circle cx="12" cy="12" r="9" />
        <circle cx="12" cy="12" r="3" />
        <path d="M12 3v3" />
        <path d="M12 18v3" />
        <path d="M3 12h3" />
        <path d="M18 12h3" />
      </svg>
      <span>Sim/AI</span>
    </a>
    <a class="tabbar__btn" href="lessons.html">
      <svg class="icon icon--tab" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
        <path d="M4 19V5l8-3 8 3v14l-8 3-8-3z" />
        <path d="M4 12l8 3 8-3" />
        <path d="M12 5v10" />
      </svg>
      <span>Lessons</span>
    </a>
    <a class="tabbar__btn" href="calculators.html">
      <svg class="icon icon--tab" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
        <rect x="3" y="4" width="18" height="16" rx="2" />
        <path d="M7 8h10" />
        <path d="M7 12h10" />
        <path d="M7 16h3" />
        <path d="M14 16h3" />
      </svg>
      <span>Calc</span>
    </a>
    <a class="tabbar__btn" href="profile.html">
      <svg class="icon icon--tab" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
        <circle cx="12" cy="8" r="4" />
        <path d="M4 20c0-4 4-6 8-6s8 2 8 6" />
      </svg>
      <span>Profile</span>
    </a>
  </nav>
  
  <!-- Article Display Component -->
  <script src="article-display.js"></script>
</body>
</html>


