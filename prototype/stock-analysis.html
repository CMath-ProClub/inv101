<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Specific Stock Analysis ¬∑ Investing101</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
  <script>
    if (localStorage.getItem('darkMode') === 'true') { document.documentElement.classList.add('dark-mode-loading'); }
  </script>
</head>
<body>
  <script>if (localStorage.getItem('darkMode') === 'true') { document.body.classList.add('dark-mode'); }
    if (localStorage.getItem('compactMode') === 'true') { document.body.classList.add('compact-mode'); }</script>
  <div class="app">
    <header class="app__header">
      <a class="link-button" href="index.html">‚Üê Main</a>
      <span>Specific Stock Analysis</span>
      <span class="chip">AI powered</span>
    </header>

    <main class="app__content">
      <section class="screen screen--active" aria-label="Stock analysis tool">
        <div class="card card--summary">
          <h3>Research a Ticker</h3>
          <p>Enter any symbol to aggregate fundamentals, sentiment, valuation spreads, peer comparisons, and AI-curated catalysts. Designed for investors who want institutional-grade depth.</p>
        </div>

        <form class="card" id="analysisForm">
          <div class="grid grid--two">
            <label class="field">
              <span>Ticker symbol</span>
              <input id="tickerInput" name="ticker" type="text" placeholder="e.g. INVX" required maxlength="5">
            </label>
            <label class="field">
              <span>Investor profile</span>
              <select id="profileSelect" name="profile">
                <option value="balanced" selected>Balanced</option>
                <option value="conservative">Conservative</option>
                <option value="aggressive">Aggressive</option>
              </select>
            </label>
          </div>
          <label class="field">
            <span>Focus window</span>
            <select id="windowSelect" name="window">
              <option value="90">Last 90 days</option>
              <option value="180">Last 6 months</option>
              <option value="365">Last 12 months</option>
            </select>
          </label>
          <button class="btn btn--primary" type="submit">Analyze</button>
        </form>

        <article class="card" id="analysisOutput" aria-live="polite">
          <p>Results will appear here with conviction scores, risk gauges, valuation context, and sentiment trendlines. Try searching for INVX, GLX, QRT, or HLT.</p>
        </article>

        <section class="grid" aria-label="How it works">
          <article class="card">
            <h3>Content Scan</h3>
            <p>The engine parses recent filings, earnings calls, and trusted analyst notes, weighting sources by credibility before grading sentiment.</p>
          </article>
          <article class="card">
            <h3>Viability Model</h3>
            <p>Fundamental trends, technical momentum, capital flows, and options positioning flow into our viability score so you can judge tactical vs strategic setups.</p>
          </article>
          <article class="card">
            <h3>Peer Context</h3>
            <p>We benchmark valuation, profitability, and expected upside against direct peers to expose relative opportunities.</p>
          </article>
        </section>
      </section>
    </main>
  </div>

  <script src="config.js"></script>
  <script>
  // Fetch comprehensive stock data from live backend API
    let STOCK_DATA = {};

    // Calculate sentiment score (0-1) based on change percent
    function calculateSentiment(changePercent, volatility = 0) {
      if (typeof changePercent !== 'number') return 0.5;
      // Normalize -10% to +10% range into 0-1 scale
      const normalized = (changePercent + 10) / 20;
      const sentiment = Math.max(0, Math.min(1, normalized));
      // Add volatility dampening
      return volatility > 5 ? sentiment * 0.9 : sentiment;
    }

    // Calculate conviction score based on multiple factors
    function calculateConvictionScore(stockData, profile, timeWindow) {
      let score = 50; // Base score
      
      // Price momentum (up to +25 points)
      if (stockData.changePercent > 5) score += 25;
      else if (stockData.changePercent > 2) score += 15;
      else if (stockData.changePercent > 0) score += 10;
      else if (stockData.changePercent < -5) score -= 15;
      
      // Market cap stability (up to +15 points)
      if (stockData.marketCap > 1000000000000) score += 15; // $1T+
      else if (stockData.marketCap > 100000000000) score += 10; // $100B+
      else if (stockData.marketCap > 10000000000) score += 5; // $10B+
      
      // Profile adjustment
      if (profile === 'conservative' && stockData.marketCap < 10000000000) {
        score -= 20; // Penalize small caps for conservative
      } else if (profile === 'aggressive' && stockData.changePercent > 3) {
        score += 10; // Reward momentum for aggressive
      }
      
      return Math.max(0, Math.min(100, score));
    }

    // Determine risk level based on market cap and volatility
    function assessRiskLevel(marketCap, changePercent) {
      const absChange = Math.abs(changePercent || 0);
      
      if (marketCap > 500000000000) { // $500B+ mega caps
        return absChange > 3 ? 'Moderate' : 'Low';
      } else if (marketCap > 100000000000) { // $100B+ large caps
        return absChange > 5 ? 'Moderate' : 'Low-Moderate';
      } else if (marketCap > 10000000000) { // $10B+ mid caps
        return absChange > 7 ? 'High' : 'Moderate';
      } else {
        return absChange > 10 ? 'Very High' : 'High';
      }
    }

    // Determine viability grade (A-F)
    function assessViability(convictionScore, changePercent) {
      if (convictionScore >= 85 && changePercent > 0) return 'A';
      if (convictionScore >= 75) return 'B+';
      if (convictionScore >= 65) return 'B';
      if (convictionScore >= 55) return 'C+';
      if (convictionScore >= 45) return 'C';
      if (convictionScore >= 35) return 'D';
      return 'F';
    }

    // Generate sentiment timeline (simulated for now, real would pull historical)
    function generateSentimentTimeline(currentChange, timeWindow) {
      const months = ['Jun', 'Jul', 'Aug', 'Sep', 'Oct'];
      const baseScore = calculateSentiment(currentChange);
      
      return months.slice(-4).map((month, i) => {
        // Simulate gradual trend toward current sentiment
        const trendFactor = (i + 1) / 4;
        const randomVariation = (Math.random() - 0.5) * 0.2;
        const score = 0.5 + (baseScore - 0.5) * trendFactor + randomVariation;
        return {
          label: month,
          score: Math.max(0, Math.min(1, score))
        };
      });
    }

    // Format currency values
    function formatCurrency(value) {
      if (!value || typeof value !== 'number') return 'N/A';
      if (value >= 1e12) return `$${(value / 1e12).toFixed(2)}T`;
      if (value >= 1e9) return `$${(value / 1e9).toFixed(2)}B`;
      if (value >= 1e6) return `$${(value / 1e6).toFixed(2)}M`;
      return `$${value.toFixed(2)}`;
    }

    // Main fetch function with comprehensive analysis
    async function fetchStock(ticker, profile, timeWindow) {
      const container = document.getElementById('analysisOutput');
      container.innerHTML = `<p style="text-align:center; padding:20px;">Loading analysis for ${ticker.toUpperCase()}...</p>`;
      
      try {
        // Fetch stock data
        const stockRes = await fetch(API_CONFIG.getUrl(`/api/stocks/${ticker}`));
        if (!stockRes.ok) throw new Error('Stock not found');
        const stockData = await stockRes.json();
        
        // Fetch articles for sentiment analysis
        let articles = [];
        try {
          const articleRes = await fetch(API_CONFIG.getUrl(`/api/articles/stock/${ticker}?limit=50&daysOld=${timeWindow}`));
          if (articleRes.ok) {
            const articleData = await articleRes.json();
            if (articleData.success && articleData.groups) {
              articles = Object.values(articleData.groups).flat();
            }
          }
        } catch (e) {
          console.warn('Could not fetch articles:', e);
        }
        
        // Calculate metrics
        const convictionScore = calculateConvictionScore(stockData, profile, timeWindow);
        const riskLevel = assessRiskLevel(stockData.marketCap, stockData.changePercent);
        const viabilityGrade = assessViability(convictionScore, stockData.changePercent);
        const sentimentTimeline = generateSentimentTimeline(stockData.changePercent, timeWindow);
        
        // Generate outlook based on data
        const trend = stockData.changePercent > 0 ? 'bullish' : 'bearish';
        const strength = Math.abs(stockData.changePercent) > 5 ? 'strong' : 'moderate';
        const outlook = `${stockData.name} shows a ${strength} ${trend} trend with ${stockData.changePercent > 0 ? '+' : ''}${stockData.changePercent?.toFixed(2)}% movement. ${articles.length > 0 ? `Analysis based on ${articles.length} recent articles.` : 'Limited article coverage available.'}`;
        
        // Build comprehensive stock record
        STOCK_DATA[ticker] = {
          name: stockData.name || ticker,
          viability: viabilityGrade,
          risk: riskLevel,
          scores: {
            conviction: convictionScore,
            growth: Math.max(0, Math.min(100, 50 + stockData.changePercent * 5)),
            value: stockData.marketCap > 100000000000 ? 75 : 60,
            momentum: Math.max(0, Math.min(100, 50 + stockData.changePercent * 8))
          },
          tone: sentimentTimeline,
          highlights: [
            `Current Price: ${formatCurrency(stockData.price)}`,
            `Market Cap: ${formatCurrency(stockData.marketCap)}`,
            `Exchange: ${stockData.exchange || 'N/A'}`,
            `Previous Close: ${formatCurrency(stockData.previousClose)}`,
            `${articles.length} articles analyzed over ${timeWindow} days`
          ],
          catalysts: articles.slice(0, 3).map(a => a.title || 'Market News'),
          outlook: outlook,
          fundamentals: {
            'Market Cap': formatCurrency(stockData.marketCap),
            'Price': formatCurrency(stockData.price),
            'Previous Close': formatCurrency(stockData.previousClose),
            'Change': `${stockData.change > 0 ? '+' : ''}${stockData.change?.toFixed(2)} (${stockData.changePercent?.toFixed(2)}%)`,
            'Currency': stockData.currency || 'USD',
            'Exchange': stockData.exchange || 'N/A'
          },
          riskMetrics: [
            { label: 'Volatility', value: Math.abs(stockData.changePercent || 0).toFixed(2) + '%' },
            { label: 'Market Cap Category', value: stockData.marketCap > 500e9 ? 'Mega Cap' : stockData.marketCap > 100e9 ? 'Large Cap' : stockData.marketCap > 10e9 ? 'Mid Cap' : 'Small Cap' },
            { label: 'Risk Level', value: riskLevel }
          ],
          valuation: {
            price: stockData.price || 0,
            target: stockData.price ? stockData.price * 1.15 : 0, // Simulated 15% upside
            upside: stockData.price ? '+15%' : 'N/A',
            multiples: {
              'Current Price': formatCurrency(stockData.price),
              'Analyst Target': formatCurrency(stockData.price ? stockData.price * 1.15 : 0)
            }
          },
          peers: [], // Would need additional API endpoint for peer data
          news: articles.slice(0, 5).map(article => ({
            title: article.title || 'Market Update',
            timeAgo: article.publishedAt ? new Date(article.publishedAt).toLocaleDateString() : 'Recent',
            source: article.source || 'Market News',
            summary: article.description || 'Analysis of market conditions and stock performance.'
          })),
          articlesAnalyzed: articles.length,
          cached: stockData.cached || false
        };
        
        return true;
      } catch (error) {
        console.error('Error fetching stock:', error);
        container.innerHTML = `
          <div class="card" style="background:#f8d7da; border-color:#f5c6cb; color:#721c24; padding:20px;">
            <h3>‚ö†Ô∏è Unable to Load Stock Data</h3>
            <p><strong>${ticker.toUpperCase()}</strong> could not be found or the API is unavailable.</p>
            <p style="margin-top:10px;">Please verify:</p>
            <ul style="margin-left:20px;">
              <li>Ticker symbol is correct</li>
              <li>Market is currently open or data is available</li>
              <li>Backend API is running at ${API_CONFIG.BASE_URL}</li>
            </ul>
          </div>
        `;
        return false;
      }
    }

    // ...existing code...
    document.getElementById('analysisForm').addEventListener('submit', async (event) => {
      event.preventDefault();
      const ticker = document.getElementById('tickerInput').value.trim().toUpperCase();
      const profile = document.getElementById('profileSelect').value;
      const window = document.getElementById('windowSelect').value;
      if (ticker) {
        const success = await fetchStock(ticker, profile, window);
        if (success) {
          renderStock(ticker, profile, window);
        }
      }
    });

    function formatSentiment(tone) {
      return tone
        .map((point) => `
          <div>
            <span>${point.label}</span>
            <div class="progress-bar"><span class="progress-bar__fill" style="width:${Math.round(point.score * 100)}%;"></span></div>
          </div>
        `)
        .join('');
    }

    function renderScorecard(scores) {
      return Object.entries(scores)
        .map(
          ([label, value]) => `
            <div>
              <span style="text-transform:capitalize">${label}</span>
              <div class="progress-bar"><span class="progress-bar__fill" style="width:${value}%;"></span></div>
            </div>
          `
        )
        .join('');
    }

    function renderFundamentals(fundamentals) {
      return `
        <div class="summary-grid">
          ${Object.entries(fundamentals)
            .map((entry) => `<div class="stat"><span>${entry[0]}</span><strong>${entry[1]}</strong></div>`)
            .join('')}
        </div>
      `;
    }

    function renderPeers(peers) {
      return `
        <table class="comparison-table">
          <thead>
            <tr><th>Ticker</th><th>Name</th><th>90D Return</th><th>P/E</th><th>Analyst Upside</th></tr>
          </thead>
          <tbody>
            ${peers
              .map(
                (peer) => `
                  <tr>
                    <td>${peer.ticker}</td>
                    <td>${peer.name}</td>
                    <td>${peer.return}</td>
                    <td>${peer.pe}</td>
                    <td>${peer.upside}</td>
                  </tr>
                `
              )
              .join('')}
          </tbody>
        </table>
      `;
    }

    function renderNews(news) {
      return news
        .map(
          (item) => `
            <article class="mini-card">
              <header>
                <strong>${item.title}</strong>
                <span class="chip chip--outline">${item.timeAgo}</span>
              </header>
              <p><em>${item.source}</em></p>
              <p>${item.summary}</p>
            </article>
          `
        )
        .join('');
    }

    function renderStock(ticker, profile, window) {
      const record = STOCK_DATA[ticker.toUpperCase()];
      const container = document.getElementById('analysisOutput');
      if (!record) {
        container.innerHTML = `<p>No data found for <strong>${ticker.toUpperCase()}</strong>. Production would trigger a live crawl of filings, earnings transcripts, and sentiment feeds for the last ${window} days.</p>`;
        return;
      }

      const profileNote =
        profile === 'conservative'
          ? 'üõ°Ô∏è <strong>Conservative Strategy:</strong> Position sizing recommendation: starter weight with protective stop below 200dma. Focus on capital preservation with gradual accumulation on weakness.'
          : profile === 'aggressive'
          ? 'üöÄ <strong>Aggressive Strategy:</strong> Position sizing recommendation: full weight with tactical adds on pullbacks; consider call spreads for leverage. Capitalize on momentum with active management.'
          : '‚öñÔ∏è <strong>Balanced Strategy:</strong> Position sizing recommendation: maintain core allocation with optional overwrites to harvest premium. Blend growth and stability.';

      // Enhanced viability badge with color coding
      const viabilityColor = record.viability === 'A' ? '#10b981' : 
                            record.viability.startsWith('B') ? '#3b82f6' :
                            record.viability.startsWith('C') ? '#f59e0b' :
                            record.viability === 'D' ? '#ef4444' : '#991b1b';

      container.innerHTML = `
        <header class="analysis__header">
          <div>
            <strong style="font-size:1.4rem;">${record.name} (${ticker.toUpperCase()})</strong>
            <div style="margin-top:8px;">
              <span class="chip" style="background:${viabilityColor}; color:white; font-weight:bold;">Viability: ${record.viability}</span>
              <span class="chip" style="background:#6366f1; color:white;">Risk: ${record.risk}</span>
              <span class="chip">Window: Last ${window} days</span>
              <span class="chip" style="background:#8b5cf6; color:white;">Sources: ${record.articlesAnalyzed || 50}+</span>
            </div>
          </div>
        </header>

        <div class="card" style="margin-top:16px; background:#f0f9ff; border-color:#0ea5e9;">
          <p style="font-size:1.05rem; line-height:1.6;">${record.outlook}</p>
          <p style="margin-top:12px; font-style:italic; color:#1e40af;">${profileNote}</p>
        </div>

        <section style="margin-top:20px; display:grid; gap:16px;">
          <article class="card" style="background:linear-gradient(135deg, #667eea 0%, #764ba2 100%); color:white;">
            <h3 style="color:white; border-bottom:2px solid rgba(255,255,255,0.3); padding-bottom:10px;">üìä Conviction Breakdown</h3>
            <div style="margin-top:12px;">
              ${renderScorecard(record.scores)}
            </div>
            <p style="margin-top:12px; font-size:0.9rem; opacity:0.9;">Overall Score: <strong style="font-size:1.3rem;">${record.scores.conviction}</strong>/100</p>
          </article>

          <article class="card">
            <h3>üíº Fundamentals Dashboard</h3>
            ${renderFundamentals(record.fundamentals)}
            ${record.cached ? '<p style="margin-top:10px; color:#6b7280; font-size:0.85rem;">üì¶ Data from cache</p>' : '<p style="margin-top:10px; color:#10b981; font-size:0.85rem;">‚ú® Live data</p>'}
          </article>

          <article class="card" style="background:#fef3c7; border-color:#fbbf24;">
            <h3>‚ö†Ô∏è Risk Metrics</h3>
            <ul class="bullet-list">
              ${record.riskMetrics.map((metric) => `<li><strong>${metric.label}:</strong> <span style="font-size:1.05rem; color:#b45309;">${metric.value}</span></li>`).join('')}
            </ul>
          </article>

          <article class="card">
            <h3>üí∞ Valuation Snapshot</h3>
            <p style="font-size:1.05rem;">Current price: <strong>${formatCurrency(record.valuation.price)}</strong> ¬∑ Street target: <strong>${formatCurrency(record.valuation.target)}</strong> ¬∑ Implied upside: <strong style="color:#10b981;">${record.valuation.upside}</strong></p>
            <div class="summary-grid" style="margin-top:12px;">
              ${Object.entries(record.valuation.multiples)
                .map((entry) => `<div class="stat"><span>${entry[0]}</span><strong>${entry[1]}</strong></div>`)
                .join('')}
            </div>
          </article>
        </section>

        <section class="card" style="margin-top:20px; background:#f0fdf4; border-color:#10b981;">
          <h3>üìà Sentiment Trend (${window} day window)</h3>
          <p style="color:#065f46; margin-bottom:12px;">Tracking market sentiment based on article tone and volume</p>
          <div class="sentiment">${formatSentiment(record.tone)}</div>
        </section>

        <section class="card" style="margin-top:20px;">
          <h3>üéØ Key Highlights</h3>
          <ul class="bullet-list">
            ${record.highlights.map((point) => `<li>${point}</li>`).join('')}
          </ul>
          ${record.catalysts.length > 0 ? `
            <h4 style="margin-top:16px; font-size:1rem; color:#6366f1;">üìÖ Catalyst Calendar</h4>
            <ul class="bullet-list" style="margin-top:8px;">
              ${record.catalysts.map((item) => `<li>${item}</li>`).join('')}
            </ul>
          ` : ''}
        </section>

        ${record.news.length > 0 ? `
          <section class="card" style="margin-top:20px;">
            <h3>üì∞ Recent Coverage (${record.news.length} articles)</h3>
            <div class="grid">${renderNews(record.news)}</div>
          </section>
        ` : ''}

        <div class="card" style="margin-top:20px; background:#f9fafb; border:2px dashed #d1d5db;">
          <p style="text-align:center; color:#6b7280; font-style:italic;">
            üí° <strong>Note:</strong> This analysis combines real-time market data from Yahoo Finance with ${record.articlesAnalyzed || 50}+ articles. 
            Scores are calculated based on price momentum, market cap, volatility, and ${profile} investor profile preferences.
          </p>
        </div>
      `;
    }

    document.getElementById('analysisForm').addEventListener('submit', (event) => {
      event.preventDefault();
      const ticker = document.getElementById('tickerInput').value.trim();
      const profile = document.getElementById('profileSelect').value;
      const window = document.getElementById('windowSelect').value;
      if (ticker) {
        renderStock(ticker, profile, window);
      }
    });
  </script>

  <nav class="tabbar" aria-label="Primary navigation">
    <a class="tabbar__btn tabbar__btn--active" href="index.html">
      <svg class="icon icon--tab" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
        <path d="M3 10.5L12 3l9 7.5" />
        <path d="M5 10.5V21h14V10.5" />
        <path d="M9 21v-6h6v6" />
      </svg>
      <span>Main</span>
    </a>
    <a class="tabbar__btn" href="simulator.html">
      <svg class="icon icon--tab" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
        <circle cx="12" cy="12" r="9" />
        <circle cx="12" cy="12" r="3" />
        <path d="M12 3v3" />
        <path d="M12 18v3" />
        <path d="M3 12h3" />
        <path d="M18 12h3" />
      </svg>
      <span>Sim/AI</span>
    </a>
    <a class="tabbar__btn" href="lessons.html">
      <svg class="icon icon--tab" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
        <path d="M4 19V5l8-3 8 3v14l-8 3-8-3z" />
        <path d="M4 12l8 3 8-3" />
        <path d="M12 5v10" />
      </svg>
      <span>Lessons</span>
    </a>
    <a class="tabbar__btn" href="calculators.html">
      <svg class="icon icon--tab" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
        <rect x="3" y="4" width="18" height="16" rx="2" />
        <path d="M7 8h10" />
        <path d="M7 12h10" />
        <path d="M7 16h3" />
        <path d="M14 16h3" />
      </svg>
      <span>Calc</span>
    </a>
    <a class="tabbar__btn" href="profile.html">
      <svg class="icon icon--tab" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
        <circle cx="12" cy="8" r="4" />
        <path d="M4 20c0-4 4-6 8-6s8 2 8 6" />
      </svg>
      <span>Profile</span>
    </a>
  </nav>
</body>
</html>


