Migration: Articles & StockPrice

This document summarizes the migration that was just executed and lists follow-up steps, verification, rollback, and automation options.

Summary
- Script used: `backend/migrate-articles-to-atlas.js`
- Verification script: `backend/scripts/check_stockprices.js`
- Action performed: Time-series price JSON (SPY_daily.json) was detected and upserted into `StockPrice`.
- Result: 30 upserts were performed (see migration logs).

Immediate post-migration checklist (actions you must perform)
1. Verify data in Atlas/Compass
   - Connect to your Atlas cluster and run:
     - `db.StockPrice.count()`
     - `db.StockPrice.find({ symbol: 'SPY' }).sort({ date: -1 }).limit(5).pretty()`

2. Rotate or create a least-privilege DB user (recommended)
   - Because a connection string was shared outside a secret store, rotate credentials now.
   - Steps in Atlas UI:
     1. Go to Database Access → Add New Database User.
     2. Create a user with role `ReadWrite` scoped to the target database only (avoid clusterAdmin).
     3. Update your environment variables and GitHub Secrets with the new connection string.
     4. Remove or disable the old user.

3. Add GitHub Actions secret and automate future migrations (recommended)
   - In your GitHub repository: Settings → Secrets and variables → Actions → New repository secret.
     - Name: `MIGRATION_DB_URI`
     - Value: your Atlas connection string
   - Run the `migrate-prices.yml` workflow from Actions UI. Use `dry_run=true` first, then `dry_run=false` for write runs.

4. Secure the server admin endpoint (optional)
   - If you plan to call `POST /api/admin/run-migration` on a deployed server, set `ADMIN_TOKEN` in the server environment to a strong, random value.
   - Call the endpoint with header `x-admin-token: <ADMIN_TOKEN>`.

5. Backups & rollback plan
   - For rollback, you can remove the inserted docs by symbol/date range. Example (mongo shell):
     ```js
     db.StockPrice.deleteMany({ symbol: 'SPY', date: { $gte: ISODate('2024-08-31T00:00:00Z'), $lte: ISODate('2024-09-29T23:59:59Z') } })
     ```
   - Create a backup export with the helper script below or via `mongodump`/Atlas snapshot.

Helper scripts included
- `backend/scripts/backup_stockprices.js`: export `StockPrice` documents to `backend/data/stockprice-backup-<timestamp>.json` (read-only).

Verification commands (local)
- Run the verification script:
  ```powershell
  $env:MONGODB_URI = 'your-atlas-uri'
  node backend/scripts/check_stockprices.js
  ```

Rollback (if needed)
- Use the delete query above or restore from Atlas snapshot / `mongorestore`.

Security notes
- Rotate DB credentials after this run.
- Prefer storing secrets in GitHub Secrets or your host's environment variables — never in repo or chat.
- Use least-privilege DB users for migration tasks.

If you want help performing any of these manual actions — rotating credentials, adding the GitHub secret, or calling the admin endpoint — tell me which and I will provide step-by-step guidance.

---
Generated by automation after local migration run on your repo.
